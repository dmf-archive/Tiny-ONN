---
title: "Tiny-ONN 项目自主代理操作手册"
version: "latest"
last_updated: "2025-11-28"
owner: "Tiny-ONN 课题组"
---

## 1. 定义

- **Agent**: AI 架构师与工程专家，本规范执行主体。
- **证据**: 文件系统、内容、用户指令、测试输出等唯一行动依据。
- **REQ (Requirement)**: 必须严格遵守的强制性规则。
- **CON (Constraint)**: 必须满足的限制或约束。
- **GUD (Guideline)**: 推荐遵循的最佳实践或建议。
- **PAT (Pattern)**: 特定情境下推荐使用的设计或实现模式。

## 2. 核心哲学

**Learn with Errors**: 系统核心驱动力是通过最小化预测误差（证据）进行学习。所有行动必须基于证据，旨在通过行动减少系统不确定性。

1. **GUD-001**: 所有行动必须基于确凿证据。若指令与证据冲突，优先采信证据并报告冲突。
2. **GUD-002**: 若指令与形式化第一性原理（数学公式、物理定律、逻辑推导）冲突，优先遵守原理并指出冲突。
3. **GUD-003**: 当行为与预期严重不符时，停止试错，回归第一性原理进行形式化分析。
4. **GUD-004**: 若行动依据的内部规则或文档过时/错误，优先报告并修正文档，再继续任务。

## 3. 知识管理

- **GUD-101**: 信任新知识，禁止用旧名词替换新概念。
- **GUD-102**: 关键术语立即用 `Tavily`/`DeepWiki` 查询。
- **REQ-101**: `transformers` 开发仅参考 `qwen3` 实现。

## 4. 编码规范

1. **REQ-001**: 代码须实现高度自解释，**严禁包含任何注释与 Docstring**。
2. **CON-002**: 必须彻底移除代码库中现有的所有注释。
3. **GUD-003**: 采用文档与规范驱动开发（如 `.roo/rules`）。
4. **REQ-004**: 完整类型标注，通过 `ruff check . --fix` 校验（`mypy .` 可选）。
5. **REQ-005**: 纯函数设计，零副作用，优先采用 PyTorch 张量并行。
6. **REQ-006**: 文档公式使用 `unicode math`，禁止使用 LaTeX 块。
7. **REQ-007**: 显式定义所有参数，固定随机种子以保证可复现性。

## 5. 设计约束

- **CON-201**: 如无必要，勿增实体（代码、函数、类、依赖）。
- **CON-202**: 禁止未经批准引入新的超参数或外部状态机制（如 EMA）。模型自身参数是其历史状态的唯一载体。
- **CON-401**: 严禁使用 Gradio 分享链接。

## 6. 环境管理

- **REQ-301**: 依赖项必须通过 `uv add/remove` 命令管理，`pyproject.toml` 是唯一真实来源。
- **REQ-304**: 禁止 `cd` 到子文件夹内启动训练；代码须支持相对导入和 `python -m` 启动。
- **GUD-301**: 若 `uv add` 失败，可使用 `uv pip install --no-deps --find-links ...` 作为临时方案。
- **GUD-302**: 研究底层依赖时，应直接查阅 `.venv/Lib/site-packages` 中的源码。
- **GUD-303**: 不确定上游库功能时，使用 `DeepWiki` 的 `ask_question` 功能查询。
- **PAT-301**: 对于特定 CUDA/PyTorch 版本的依赖，应将 `.whl` 索引添加到 `pyproject.toml` 的 `[[tool.uv.index]]` 部分，然后运行 `uv add`。
- **PAT-302**: 修改上游库时，必须优先采用“模型手术”模式（继承和替换最小组件），而不是覆写庞杂的 `forward` 方法。

## 7. 工作流协议

- **REQ-401**: **原子重塑** - 识别关键依赖链路边界，重构内部实现，确保对外 API 完全兼容。
- **SOP-001**: 对文件是否存在疑问时，必须使用 `ls` 等 PowerShell 命令进行验证。
- **SOP-002**: 若关键操作连续失败三次，必须暂停并向用户征询意见。
- **SOP-003**: 每进行 10 次文件编辑后，必须自主运行 `ruff check . --fix; mypy .`。
- **SOP-004**: 当一个任务正在后台终端运行而你需要等待时，严禁使用空命令。应使用 `ask_followup_question` 或 `attempt_completion` 来暂停并等待用户提供日志结果。
- **CON-203**: 一次 `apply_diff` 不得超过 10 个 SEARCH/REPLACE 块。

## 8. 调试与异常处理

- **REQ-402**: 严禁在训练流程和模型代码中使用 `try...except` 静默捕获异常（数据加载或用户中断等可预期情况除外）。研究原型必须 **Just in Fail**。
- **REQ-404**: 所有 `python -m` 启动命令必须使用点分隔符（`.`）指代模块路径 (e.g., `python -m exp.arc_rmsuon.train`)。
- **GUD-401**: 对于编辑器短暂注入的不存在的格式错误，应暂时搁置。
- **GUD-402**: 若终端输出包含 `KeyboardInterrupt`，忽略其上的堆栈跟踪信息，并等待用户下一步指令。

## 9. 内存与性能

- **REQ-501**: **GPU 张量累积禁令** - 禁止使用 `.detach()` 将 GPU 张量累积到 Python 列表。应在 CPU 上进行标量累积。
- **REQ-502**: 跨 step 的统计量必须以流式方式计算（例如，在 epoch 结束时使用累加值计算最终平均值）。
- **REQ-503**: 必须实现实时可观测性，例如通过 `rich.progress` 或 `wandb` 在每个 epoch 结束时更新关键指标。

## 10. 测试与验收标准

- **AC-001**: 所有代码必须通过 `ruff check . --fix`（可选 `mypy .`）。
- **AC-002**: 所有依赖项必须已通过 `uv add` 正确添加到 `pyproject.toml`。
- **AC-003**: 实验启动命令必须遵循 `python -m exp.<experiment_name>.train` 的格式。
- **AC-004**: "原子重塑"操作必须保持外部接口完全透明。

## 11. 空间级环境管理 (Chain:// Space)

- **REQ-307**: 严禁使用系统默认的 `uv` 缓存。必须确保 `UV_CACHE_DIR` 指向 `../cache/uv`。
- **CON-308**: 在执行 `uv sync/add` 前，Agent 必须验证环境变量。若未设置，应提示用户运行 `research-env.ps1` 或检查 `.vscode` 配置。
- **GUD-309**: 所有的 Python 运行时应通过 `UV_PYTHON_INSTALL_DIR` 集中管理在 `cache/python` 中。
