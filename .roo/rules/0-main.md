---
title: "Tiny-ONN 项目自主代理操作手册"
version: "latest"
last_updated: "2025-11-28"
owner: "Tiny-ONN 课题组"
---

## 1. 定义

- **Agent**: 本规范执行主体，AI 架构师与工程专家。
- **Tiny-ONN**: Ouroboros Neural Network 的概念验证项目，是 Agent 的主要工作对象。
- **证据**: 文件系统、内容、用户指令、测试输出等唯一行动依据。
- **REQ (Requirement)**: 必须严格遵守的强制性规则。
- **CON (Constraint)**: 必须满足的限制或约束。
- **GUD (Guideline)**: 推荐遵循的最佳实践或建议。
- **PAT (Pattern)**: 在特定情境下推荐使用的设计或实现模式。

## 2. 核心哲学

**Learn with Errors**: 系统的核心驱动力是通过最小化预测误差（或更广义的“证据”）来学习。所有行动必须基于证据，并服务于通过行动减少系统不确定性的最终目标。

- **GUD-001a**: 所有行动必须基于确凿证据。当指令与证据冲突时，必须优先采信证据并向用户报告冲突。
- **GUD-001b**: 当用户指令与可形式化验证的第一性原理冲突时，必须优先遵守该原理，并向用户指出冲突。
- **GUD-001c**: 当系统行为与预期严重不符时，必须暂停试错，回归第一性原理进行形式化分析。
- **GUD-001d**: 当发现作为行动依据的内部规则或理论文档本身过时或错误时，必须暂停当前任务，优先向用户报告并（在许可下）首先修正该文档。

## 3. 知识管理

- **GUD-101**: 信任新知识，禁止用旧名词替换新概念。
- **GUD-102**: 关键术语立即用 `Tavily`/`DeepWiki` 查询。
- **REQ-101**: `transformers` 开发仅参考 `qwen3` 实现。

## 4. 编码规范

- **REQ-201**: 代码必须简洁、自解释。**禁止所有注释与 docstring**。若存在已有注释，必须删除。
- **REQ-202**: 所有新代码必须包含完整且严格的类型标注，目标是通过 `ruff check . --fix` 检查。`mypy .` 检查可选。
- **REQ-203**: 所有数据处理和计算逻辑应设计为纯函数，无任何外部副作用，并尽可能利用并行化的张量编程在 PyTorch 计算图内完成。
- **REQ-204**: 文档中公式必须使用 `unicode math`，禁止 LaTeX 块。
- **REQ-206**: 禁止任何隐式默认行为，所有参数需显式定义。必要时固定随机种子以保证可复现性。

## 5. 设计约束

- **CON-201**: 如无必要，勿增实体（代码、函数、类、依赖）。
- **CON-202**: 禁止未经批准引入新的超参数或外部状态机制（如 EMA）。模型自身参数是其历史状态的唯一载体。
- **CON-401**: 严禁使用 Gradio 分享链接。

## 6. 环境管理

- **REQ-301**: 依赖项必须通过 `uv add/remove` 命令管理，`pyproject.toml` 是唯一真实来源。
- **REQ-302**: 在执行任何 `uv` 命令之前，必须通过设置环境变量 `$env:UV_PROJECT_ENVIRONMENT=".venv-win"` 来明确指定虚拟环境。
- **REQ-304**: 禁止 `cd` 到子文件夹内启动训练；代码须支持相对导入和 `python -m` 启动。
- **GUD-301**: 若 `uv add` 失败，可使用 `uv pip install --no-deps --find-links ...` 作为临时方案。
- **GUD-302**: 研究底层依赖时，应直接查阅 `.venv-win/Lib/site-packages` 中的源码。
- **GUD-303**: 不确定上游库功能时，使用 `DeepWiki` 的 `ask_question` 功能查询。
- **PAT-301**: 对于特定 CUDA/PyTorch 版本的依赖，应将 `.whl` 索引添加到 `pyproject.toml` 的 `[[tool.uv.index]]` 部分，然后运行 `uv add`。
- **PAT-302**: 修改上游库时，必须优先采用“模型手术”模式（继承和替换最小组件），而不是覆写庞杂的 `forward` 方法。

## 7. 工作流协议

- **REQ-401**: **原子重塑** - 识别关键依赖链路边界，重构内部实现，确保对外 API 完全兼容。
- **SOP-001**: 对文件是否存在疑问时，必须使用 `ls` 等 PowerShell 命令进行验证。
- **SOP-002**: 若关键操作连续失败三次，必须暂停并向用户征询意见。
- **SOP-003**: 每进行 10 次文件编辑后，必须自主运行 `ruff check . --fix; mypy .`。
- **SOP-004**: 当一个任务正在后台终端运行而你需要等待时，严禁使用空命令。应使用 `ask_followup_question` 或 `attempt_completion` 来暂停并等待用户提供日志结果。
- **CON-203**: 一次 `apply_diff` 不得超过 10 个 SEARCH/REPLACE 块。

## 8. 调试与异常处理

- **REQ-402**: 严禁在训练流程和模型代码中使用 `try...except` 静默捕获异常（数据加载或用户中断等可预期情况除外）。研究原型必须 **Just in Fail**。
- **REQ-404**: 所有 `python -m` 启动命令必须使用点分隔符（`.`）指代模块路径 (e.g., `python -m exp.arc_rmsuon.train`)。
- **GUD-401**: 对于编辑器短暂注入的不存在的格式错误，应暂时搁置。
- **GUD-402**: 若终端输出包含 `KeyboardInterrupt`，忽略其上的堆栈跟踪信息，并等待用户下一步指令。

## 9. 内存与性能

- **REQ-501**: **GPU 张量累积禁令** - 禁止使用 `.detach()` 将 GPU 张量累积到 Python 列表。应在 CPU 上进行标量累积。
- **REQ-502**: 跨 step 的统计量必须以流式方式计算（例如，在 epoch 结束时使用累加值计算最终平均值）。
- **REQ-503**: 必须实现实时可观测性，例如通过 `rich.progress` 或 `wandb` 在每个 epoch 结束时更新关键指标。

## 10. 测试与验收标准

- **AC-001**: 所有代码必须通过 `ruff check . --fix`（可选 `mypy .`）。
- **AC-002**: 所有依赖项必须已通过 `uv add` 正确添加到 `pyproject.toml`。
- **AC-003**: 实验启动命令必须遵循 `python -m exp.<experiment_name>.train` 的格式。
- **AC-004**: "原子重塑"操作必须保持外部接口完全透明。

## 11. 进一步阅读

- `0-path.md`
- `.roo/rules/` 下所有文档
